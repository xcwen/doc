<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<title>proto</title>
<!-- 2014-08-05 二 17:38 -->
<meta  http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta  name="generator" content="Org-mode" />
<meta  name="author" content="jim" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center; }
  .todo   { font-family: monospace; color: red; }
  .done   { color: green; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  pre.src-sh:before    { content: 'sh'; }
  pre.src-bash:before  { content: 'sh'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-R:before     { content: 'R'; }
  pre.src-perl:before  { content: 'Perl'; }
  pre.src-java:before  { content: 'Java'; }
  pre.src-sql:before   { content: 'SQL'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.right  { text-align: center;  }
  th.left   { text-align: center;   }
  th.center { text-align: center; }
  td.right  { text-align: right;  }
  td.left   { text-align: left;   }
  td.center { text-align: center; }
  dt { font-weight: bold; }
  .footpara:nth-child(2) { display: inline; }
  .footpara { display: block; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  /*]]>*/-->
</style>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2013 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">proto</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">1. 概要</a></li>
<li><a href="#sec-2">2. 架构图</a></li>
<li><a href="#sec-3">3. 编辑页面使用方法</a>
<ul>
<li><a href="#sec-3-1">3.1. 进入协议平台</a></li>
<li><a href="#sec-3-2">3.2. 协议项目操作</a></li>
<li><a href="#sec-3-3">3.3. 命令操作</a></li>
<li><a href="#sec-3-4">3.4. 结构体操作</a></li>
<li><a href="#sec-3-5">3.5. 绑定列表</a></li>
<li><a href="#sec-3-6">3.6. 权限分配</a></li>
</ul>
</li>
<li><a href="#sec-4">4. 由.tpro文件生成proto.xml 文件</a>
<ul>
<li><a href="#sec-4-1">4.1. 文件名称约定</a></li>
<li><a href="#sec-4-2">4.2. 可用的类型</a></li>
<li><a href="#sec-4-3">4.3. 增强功能&#x2013;支持 定义同一长度</a></li>
<li><a href="#sec-4-4">4.4. 案例文件</a></li>
</ul>
</li>
<li><a href="#sec-5">5. 生成代码使用方法</a>
<ul>
<li><a href="#sec-5-1">5.1. 下载文件</a></li>
<li><a href="#sec-5-2">5.2. c++ 代码的整合</a></li>
<li><a href="#sec-5-3">5.3. php 代码的整合</a></li>
<li><a href="#sec-5-4">5.4. python 代码的整合</a></li>
</ul>
</li>
<li><a href="#sec-6">6. 打印协议数据</a></li>
<li><a href="#sec-7">7. xml 文件数据加载 到 C++  中</a>
<ul>
<li><a href="#sec-7-1">7.1. 例子</a></li>
<li><a href="#sec-7-2">7.2. 将xml导入成 map</a></li>
<li><a href="#sec-7-3">7.3. int 数组导入</a></li>
</ul>
</li>
<li><a href="#sec-8">8. 编辑器支持</a>
<ul>
<li><a href="#sec-8-1">8.1. 支持.tpro 文件语法高亮</a>
<ul>
<li><a href="#sec-8-1-1">8.1.1. vim</a></li>
<li><a href="#sec-8-1-2">8.1.2. emacs</a></li>
</ul>
</li>
<li><a href="#sec-8-2">8.2. 支持 F7 查找 命令相关的 xxx<sub>cmd</sub>,xxx<sub>in</sub>,xxx<sub>out</sub></a>
<ul>
<li><a href="#sec-8-2-1">8.2.1. vim</a></li>
<li><a href="#sec-8-2-2">8.2.2. emacs</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> 概要</h2>
<div class="outline-text-2" id="text-1">
<p>
类似于 google 的 protobuf , 提供php ,python ,c++  序列化对象的生成代码.
</p>

<p>
提供网页编辑界面 并 输出 规范化的 <b>协议输出文档</b>. 可清晰看出相关协议的完整内容。
</p>

<p>
提供 生成客户端测试协议, 可以对程序 进行 协议级的 有效而且轻便的测试 .
</p>

<p>
提供 <b>xml文件读取</b>,  xml文件的数据可加载到协议平台编辑的结构体里.
</p>

<p>
有效地和   server<sub>bench</sub>, async<sub>server</sub>  整合
</p>

<p>
目前 协议平台支持了几乎公司的所有开发项目。用于定义服务器程序对外提供的协议接口.
</p>
</div>
</div>


<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2"><span class="section-number-2">2</span> 架构图</h2>
<div class="outline-text-2" id="text-2">

<div class="figure">
<p><img src="./images/proto_5.png" alt="proto_5.png" />
</p>
</div>
</div>
</div>

<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3"><span class="section-number-2">3</span> 编辑页面使用方法</h2>
<div class="outline-text-2" id="text-3">
</div><div id="outline-container-sec-3-1" class="outline-3">
<h3 id="sec-3-1"><span class="section-number-3">3.1</span> 进入协议平台</h3>
<div class="outline-text-3" id="text-3-1">
<p>
<b>chrome</b> (不要使用其它浏览器) 中 打开 10.1.1.5/cc 
</p>

<p>
输入用户名密码(测试  用户名: comm ,  密码: 142857 )
</p>

<p>
进入界面:
</p>


<div class="figure">
<p><img src="./images/proto_1.png" alt="proto_1.png" />
</p>
</div>
</div>
</div>


<div id="outline-container-sec-3-2" class="outline-3">
<h3 id="sec-3-2"><span class="section-number-3">3.2</span> 协议项目操作</h3>
<div class="outline-text-3" id="text-3-2">
<p>
可增加，删除,修改 协议项目
</p>

<p>
协议项目名称规则: 
</p>

<p>
1.名称分为两个部分 用 "_" 分开 如: mole<sub>db</sub>
</p>

<p>
2.在同一个项目（如摩尔）的 <b>第一个部分要一样</b> (如 mole<sub>db</sub> ,mole<sub>online</sub>,mode<sub>switch</sub> )
</p>

<p>
命令号显示方式 :  在界面上显示的命令号是以什么方式显示的. 一般dbser的协议是16进制显示的，其它的都为10进制.
</p>
</div>
</div>


<div id="outline-container-sec-3-3" class="outline-3">
<h3 id="sec-3-3"><span class="section-number-3">3.3</span> 命令操作</h3>
<div class="outline-text-3" id="text-3-3">
<p>
例子:
<img src="./images/proto_2.png" alt="proto_2.png" />
</p>


<p>
需要用到的 结构体和错误码 在以下地方配置
</p>


<div class="figure">
<p><img src="./images/proto_3.png" alt="proto_3.png" />
</p>
</div>

<p>
<b>导入导出xml定义</b> 就是一个简单的复制结构的方法。
</p>

<p>
将一个结构体的xml定义复制出来，然后在另外一个结构体复制进去。
</p>
</div>
</div>

<div id="outline-container-sec-3-4" class="outline-3">
<h3 id="sec-3-4"><span class="section-number-3">3.4</span> 结构体操作</h3>
<div class="outline-text-3" id="text-3-4">

<div class="figure">
<p><img src="./images/proto_4.png" alt="proto_4.png" />
</p>
</div>


<p>
<b>公共结构体</b> 和 <b>自身定义</b> 区别
</p>

<p>
<b>公共结构体</b> 是项目级的,如 mole<sub>db</sub> 定义的  公共结构体 , 
在 mole<sub>onine</sub> mole<sub>switch</sub> 也可以使用.
</p>


<p>
 <b>自身定义</b> 只能自己使用，如: mole<sub>db</sub> 定义的    <b>自身定义结构体</b> 只能在mole<sub>db使用</sub> ,  
而在mole<sub>online</sub>,mole<sub>switch</sub> 中是看不到的.
</p>

<p>
一般是在多个协议项目使用到的结构体才需要用到公共结构体.
</p>
</div>
</div>

<div id="outline-container-sec-3-5" class="outline-3">
<h3 id="sec-3-5"><span class="section-number-3">3.5</span> 绑定列表</h3>
<div class="outline-text-3" id="text-3-5">
<p>
一个对命令分类的功能.每个命令都可以加入某几个分类中.
</p>

<p>
使用场景: online 编辑的协议中，有些要由客户端请求后触发，有些却online 自己主动发出的. 
</p>

<p>
客户端请求的协议需要写 对应的实现函数. 
</p>

<p>
一旦将 客户端请求的协议 分类出来， 如 for<sub>cli</sub><sub>request</sub> ; 这样程序就可以按 <b>分类</b> 生成文件,
</p>

<p>
里边是分类中的每个命令的信息
</p>

<p>
内容如下 mole<sub>online</sub><sub>bind</sub><sub>for</sub><sub>cli</sub><sub>request</sub>.h 
</p>

<div class="org-src-container">

<pre class="src src-c++">/*1-for_cli_request-客户端请求*/
BIND_PROTO_CMD(1010,cli_user_level_up,Cmessage,cli_user_level_up_out,0x3f695426,2)
BIND_PROTO_CMD(1011,cli_get_user_attr,Cmessage,cli_get_user_attr_out,0x2abf0e2f,2)
BIND_PROTO_CMD(1029,cli_sync_position,cli_sync_position_in,Cmessage,0x872cad30,2)
BIND_PROTO_CMD(1031,cli_proto_leave_map,Cmessage,cli_proto_leave_map_out,0x8bd11810,10)
</pre>
</div>

<p>
这里包含了协议的 命令号, 命令名称，请求包，返回包 的信息
</p>

<p>
只要重新定义一下 BIND<sub>PROTO</sub><sub>CMD</sub> 宏就可以实现很多 的事情 ,如:
</p>

<p>
生成回调函数定义 之类的
</p>

<p>
使用方法如下:
</p>

<div class="org-src-container">

<pre class="src src-c++">//函数定义
#undef  BIND_PROTO_CMD
#define BIND_PROTO_CMD(cmdid,proto_name,c_in,c_out,md5_tag,bind_bitmap ) \
    int proto_name( Csprite *p , Cmessage* c_in ) ;
#include "./proto/mole_online_bind_for_cli_request.h"


//初始化数据
#undef  BIND_PROTO_CMD
#define BIND_PROTO_CMD(cmdid,proto_name,c_in,c_out,md5_tag,bind_bitmap ) \
    {cmdid, new (c_in), md5_tag,bind_bitmap ,proto_name },

    Ccmd&lt; P_DEALFUN_T&gt; cmd_list[]={
#include "./proto/mole_online_bind_for_cli_request.h"
    };
    g_cli_cmd_map.initlist(cmd_list, sizeof(cmd_list)/sizeof(cmd_list[0]));
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-3-6" class="outline-3">
<h3 id="sec-3-6"><span class="section-number-3">3.6</span> 权限分配</h3>
<div class="outline-text-3" id="text-3-6">
<p>
选择协议项目后，在 "其它设置" , 点击 "权限列表"
</p>

<p>
可以给用户增加删除权限
</p>

<p>
如给客服平台的更新帐户增加查看权限.
用户 : kf
</p>


<div class="figure">
<p><img src="./images/proto_8.png" alt="proto_8.png" />
</p>
</div>
</div>
</div>
</div>

<div id="outline-container-sec-4" class="outline-2">
<h2 id="sec-4"><span class="section-number-2">4</span> 由.tpro文件生成proto.xml 文件</h2>
<div class="outline-text-2" id="text-4">
<p>
由于使用web页面编辑方案，很难实现svn 的管理，使用类似protobuf定义文件方案却可以实现
</p>
</div>

<div id="outline-container-sec-4-1" class="outline-3">
<h3 id="sec-4-1"><span class="section-number-3">4.1</span> 文件名称约定</h3>
<div class="outline-text-3" id="text-4-1">
<p>
一个项目 中包含多个文件，如 奥特曼项目 , online ,db,switch,login
</p>

<p>
那么出现的定义文件有
</p>
<div class="org-src-container">

<pre class="src src-sh">ultraman.tpro    #公共结构体所在的文件
ultraman_online.tpro  #online 的协议定义
ultraman_db.tpro  #db 的协议定义
ultraman_switch.tpro  #switch 的协议定义
ultraman_login.tpro  #login 的协议定义
</pre>
</div>
</div>
</div>


<div id="outline-container-sec-4-2" class="outline-3">
<h3 id="sec-4-2"><span class="section-number-3">4.2</span> 可用的类型</h3>
<div class="outline-text-3" id="text-4-2">
<div class="org-src-container">

<pre class="src src-c++">uint8_t uint16_t uint32_t uint64_t

int8_t  int16_t  int32_t  int64_t

double

char    varchar(变长字符串)

binary  varbinary(变长二进制)

vector&lt;类型&gt;  变长数组


class {   //自定义类型
  uint32_t userid; 
  char nick[32];
};
</pre>
</div>
</div>
</div>



<div id="outline-container-sec-4-3" class="outline-3">
<h3 id="sec-4-3"><span class="section-number-3">4.3</span> 增强功能&#x2013;支持 定义同一长度</h3>
<div class="outline-text-3" id="text-4-3">
<p>
如很多协议都要使用到nick;
</p>

<p>
如 char nick[ 32 ];
</p>

<p>
可以使用 
</p>
<div class="org-src-container">

<pre class="src src-c++">/* 在 公共结构体所在的文件 长度定义在  enum_pub_field_len
各自的定义在  enum_field_len

*/
enum  enum_pub_field_len {
    MSG_MAX_LEN = 2048,
    NICK_LEN = 16, //session 的长度
};

class xxx {
  .....
  char nick[NICK_LEN];
  .....
};
</pre>
</div>


<p>
这样当nick 长度调整了， 需要调整NICK<sub>LEN</sub> 就行
</p>
</div>
</div>


<div id="outline-container-sec-4-4" class="outline-3">
<h3 id="sec-4-4"><span class="section-number-3">4.4</span> 案例文件</h3>
<div class="outline-text-3" id="text-4-4">
<p>
定义文件和c++ 源代码 相似
</p>

<p>
<b>ultraman.tpro</b>:
</p>
<div class="org-src-container">

<pre class="src src-c++">//结构体
//定义长度

enum  enum_pub_field_len {
    MSG_MAX_LEN = 2048,
    NICK_LEN = 32, //session 的长度
};

class uid_role_t {
    uint32_t        user_id; //米米号 
    uint32_t        role_tm; //角色创建时间 

};

class  user_info_t {
    uint32_t  age;   //年龄
    char nick [NICK_LEN];  //昵称
    varbinary offline_msg[MSG_MAX_LEN ]; //离线消息
    varchar title[256]; //标题
};
</pre>
</div>

<p>
<b>ultraman<sub>online</sub>.tpro</b>:
</p>
<div class="org-src-container">

<pre class="src src-c++">#include "ultraman.tpro"

//注释格式 //说明;绑定列表;错误码
enum enum_cmd {
    cli_login_cmd                       = 1001  ,//登陆 ;for_cli_request;cli_session_err 
    cli_get_user_info_list_cmd          = 1002  ,//得到用户列表;for_cli_request;

};
enum  enum_field_len {
    SESSION_LEN= 16, //session 的长度
};


//绑定列表 注释格式 //xxxxx
enum enum_bind {

    for_reply_cli   = 0, //服务器主动发 
    for_cli_request = 1, //客户端请求 
};
//错误码列表 注释格式 //xxxxx
enum enum_error {

    succ    = 0, //成功 
    cli_area_id_err = 100002, //服务器异常 
    cli_session_err = 100003, //session出错

};


class cli_login_in {
    binary session[SESSION_LEN ];
    char  nick [ NICK_LEN];
};



class cli_get_user_info_list_in {
    uid_role_t  user;   //用户信息
};

class cli_get_user_info_list_out {
    vector &lt;user_info_t &gt; user_list;
};
</pre>
</div>
</div>
</div>
</div>


<div id="outline-container-sec-5" class="outline-2">
<h2 id="sec-5"><span class="section-number-2">5</span> 生成代码使用方法</h2>
<div class="outline-text-2" id="text-5">
</div><div id="outline-container-sec-5-1" class="outline-3">
<h3 id="sec-5-1"><span class="section-number-3">5.1</span> 下载文件</h3>
<div class="outline-text-3" id="text-5-1">
<p>
下载 gen<sub>proto</sub> 程序  <a href="./adds/gen_proto.tar.gz"><b>这里</b></a> 
</p>

<p>
<b>getxml.sh</b> : 生成代码的shell文件
</p>

<p>
例子如下:
</p>

<div class="org-src-container">

<pre class="src src-sh">#!/bin/bash
#固定部分
cd `dirname $0`
. ./gen_proto_app/bin/getxml_comm.sh $*

#自定义部分
get_deal_xml mole_online
get_deal_xml mole_db

# 复制需要的文件到自己项目中
cplist=" \
    mole.cpp\
    mole.h\
    mole_online.cpp\
    mole_online.h\
    mole_db.cpp\
    mole_db.h\
    mole_online_enum.h\
    mole_online_online_cli_src.cpp\
    mole_online_bind_for_cli_request.h\
    mole_db_bind_for_online.h\
    mole_db_online_db_src.cpp\
    mole_db_enum.h\
"
obj_dir="../src/proto/"
for  cpfile in $cplist 
do

    diff ./proto/$cpfile $obj_dir    1&gt;/dev/null 2&gt;&amp;1
    if [ $? -ne  0 ] ;  then
        echo "更新 $cpfile"
        cp ./proto/$cpfile $obj_dir 
    fi

done
</pre>
</div>

<p>
调整 get<sub>deal</sub><sub>xml</sub>  的 参数 ，如设置为  mole<sub>db</sub> ,就会拉取mole<sub>db</sub> 的相关内容
</p>

<p>
运行后getxml.sh 后会生成相关代码,最终的目录结构如下 
</p>
<div class="org-src-container">

<pre class="src src-sh">.
├── bak
├── bin
├── gen_proto_app 
├── getxml.sh
├── `php`
├── plugin
├── `proto`
├── `python`
├── svn-commit.tmp
├── tools
└── xml
</pre>
</div>

<p>
生成 c++ ,php ,python 的代码  分别放在  proto ,php ,python 目录 .
</p>
</div>
</div>

<div id="outline-container-sec-5-2" class="outline-3">
<h3 id="sec-5-2"><span class="section-number-3">5.2</span> c++ 代码的整合</h3>
<div class="outline-text-3" id="text-5-2">
<p>
都在proto 文件夹中
</p>

<p>
会生成项目级(mole)的文件
</p>
<div class="org-src-container">

<pre class="src src-sh">#对象序列化代码
mole.cpp
mole.h
</pre>
</div>

<p>
还会生成协议项目级的文件
</p>
<div class="org-src-container">

<pre class="src src-sh">#对象序列化代码
mole_online.cpp
mole_online.h
mole_db.cpp
mole_db.h

#生成命令号，错误码之类的信息
mole_online_enum.h
...

#绑定列表文件
mole_online_bind_for_cli_request.h
...
</pre>
</div>

<p>
对象序列化代码文件需要加入程序中编译
</p>

<p>
其它文件 视情况整合
</p>
</div>
</div>

<div id="outline-container-sec-5-3" class="outline-3">
<h3 id="sec-5-3"><span class="section-number-3">5.3</span> php 代码的整合</h3>
<div class="outline-text-3" id="text-5-3">
<p>
目前主要用于db协议的测试 ， 
</p>
</div>
</div>

<div id="outline-container-sec-5-4" class="outline-3">
<h3 id="sec-5-4"><span class="section-number-3">5.4</span> python 代码的整合</h3>
<div class="outline-text-3" id="text-5-4">
<p>
目前主要用于online 协议的测试 ， 
</p>
</div>
</div>
</div>

<div id="outline-container-sec-6" class="outline-2">
<h2 id="sec-6"><span class="section-number-2">6</span> 打印协议数据</h2>
<div class="outline-text-2" id="text-6">
<p>
使用python 生成的代码来打印 协议的16进制报文 
</p>

<p>
1:程序中需要将收到和接收到的报文打印成16进制格式, 保存到日志 
</p>


<p>
2:查看数据, 例子参照 tools/onlinei, tools/onlineo 
</p>

<div class="org-src-container">

<pre class="src src-text">#onlinei 代码
../gen_proto/gen_proto_app/bin/cat_proto -b -i -f"cmdid,H,4,2|userid,L,6,4|seqid,L,10,4|result,l,14,4"  -p ../gen_proto/python/ultraman_online_proto.py  $*
</pre>
</div>

<div class="org-src-container">

<pre class="src src-text">#cat_proto 命令参数
$ ../gen_proto/gen_proto_app/bin/cat_proto
Usage: cat_proto 16 00 00 00 C9 00 0C 00 E9 03 00 00 00 00 58 C3 00 00 00 00 00 00 

show proto pkg

Options:
  --version             show program's version number and exit
  -h, --help            show this help message and exit
  -p PY_CODE_FILE, --py_code_file=PY_CODE_FILE
                        生成的proto文件名:如mole_proto.py
  -l HEADER_LEN, --header_len=HEADER_LEN
                        报头长度
  -H, --cmd_hex_show    命令号是否要十六进制显示
  -B, --hex_show_buf    是否将buf打印成16进制
  -i, --is_in_pkg       是否是输入报文,如果不是则为输出报文
  -f HEADER_FMT_LIST, --header_fmt_list=HEADER_FMT_LIST
                        头部数据解析列表,
                        名字,解析方式,开始位置,长度
                        .必须要有cmdid
                        如 cmdid,H,4,2|userid,L,14,4|seqid,L,4,4|result,l,10,4
  -b, --big_endian      是不是大端协议
</pre>
</div>


<p>
例子:
</p>

<div class="org-src-container">

<pre class="src src-text">$ ./onlinei 00 00 00 1B 04 05 00 00 C3 80 00 00 00 6D 00 00 00 00 00 00 00 02 00 08 BE 02 7D 
报文总长:   [27]
cmdid:      [1029]
userid:     [50048]
seqid:      [109]
result:     [0]


XML生成时间:    2013年06月03日 星期1 16:32:21
协议名称:   cli_sync_position
私有结构:   cli_sync_position_in
    /* 时间戳 */
    [timestamp]=2
    /* 0:人,1:宠物 */
    [type]=0
    /* 人的位置 */
    [postion]=&gt;{
        /*  */
        [map_x]=2238
        /*  */
        [map_y]=637
    }
---------------------------------------

解析成功
---------------------------------------
</pre>
</div>
</div>
</div>



<div id="outline-container-sec-7" class="outline-2">
<h2 id="sec-7"><span class="section-number-2">7</span> xml 文件数据加载 到 C++  中</h2>
<div class="outline-text-2" id="text-7">
<p>
将xml 文件加载到 Cmessage 对象(协议平台中定义的结构体)中, 而无需写额外的代码
</p>
</div>

<div id="outline-container-sec-7-1" class="outline-3">
<h3 id="sec-7-1"><span class="section-number-3">7.1</span> 例子</h3>
<div class="outline-text-3" id="text-7-1">
<p>
xml 结构:
</p>
<div class="org-src-container">

<pre class="src src-xml">&lt;root&gt;
    &lt;title id="600000" add_phy_def_rate="0.1" module_type="1" main_type="1" 
add_solar_atk_rate="0" order="1" condition="等级排行第1" 
add_solar_def_rate="0" ranking="1" 
add_phy_atk_rate="0.1" title_name="奥特第一人" &gt;
            &lt;/title&gt;
    &lt;title id="600001" add_phy_def_rate="0" module_type="2" main_type="1"
 add_solar_atk_rate="0.1" order="2" condition="拥有金币数量排行第1名和第2名" 
add_solar_def_rate="0.1" ranking="2" add_phy_atk_rate="0.1" title_name="富甲天下" &gt;
            &lt;/title&gt;
&lt;/root&gt;
</pre>
</div>

<p>
对应的 结构体 
</p>


<div class="figure">
<p><img src="./images/proto_6.png" alt="proto_6.png" />
</p>
</div>


<div class="figure">
<p><img src="./images/proto_7.png" alt="proto_7.png" />
</p>
</div>
</div>
</div>

<div id="outline-container-sec-7-2" class="outline-3">
<h3 id="sec-7-2"><span class="section-number-3">7.2</span> 将xml导入成 map</h3>
<div class="outline-text-3" id="text-7-2">
<p>
将变长数组 的说明 设置成 
</p>
<div class="org-src-container">

<pre class="src src-text">生成map代码配置{{  "load_xml_use_map" : true }}使用std::map保存数据,key 为第一个字段
</pre>
</div>

<p>
在上面的例子中
</p>

<p>
C++ 代码中会多生成出 _title<sub>map</sub> 的std::map 对象 , key 是 id 
</p>

<p>
这样就可能直接使用id 查找数据了
</p>

<p>
并会生成 成员函数 get<sub>title</sub><sub>item</sub><sub>by</sub><sub>id</sub>(uint32<sub>t</sub> dd )
</p>
</div>
</div>


<div id="outline-container-sec-7-3" class="outline-3">
<h3 id="sec-7-3"><span class="section-number-3">7.3</span> int 数组导入</h3>
<div class="outline-text-3" id="text-7-3">
<p>
策划经常会 编辑出这样的字段，idlist="1008,1009,1011 ";
</p>

<p>
这时你可以将之导入成   uint32 的 变长数组.  
</p>
</div>
</div>
</div>


<div id="outline-container-sec-8" class="outline-2">
<h2 id="sec-8"><span class="section-number-2">8</span> 编辑器支持</h2>
<div class="outline-text-2" id="text-8">
</div><div id="outline-container-sec-8-1" class="outline-3">
<h3 id="sec-8-1"><span class="section-number-3">8.1</span> 支持.tpro 文件语法高亮</h3>
<div class="outline-text-3" id="text-8-1">
<p>
当做cpp文件处理
</p>
</div>
<div id="outline-container-sec-8-1-1" class="outline-4">
<h4 id="sec-8-1-1"><span class="section-number-4">8.1.1</span> vim</h4>
<div class="outline-text-4" id="text-8-1-1">
<div class="org-src-container">

<pre class="src src-cpp">autocmd BufEnter *.tpro  set filetype=cpp
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-8-1-2" class="outline-4">
<h4 id="sec-8-1-2"><span class="section-number-4">8.1.2</span> emacs</h4>
<div class="outline-text-4" id="text-8-1-2">
<div class="org-src-container">

<pre class="src src-elisp">(add-to-list 'auto-mode-alist (cons "\\.tpro\\'" 'c++-mode))
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-sec-8-2" class="outline-3">
<h3 id="sec-8-2"><span class="section-number-3">8.2</span> 支持 F7 查找 命令相关的 xxx<sub>cmd</sub>,xxx<sub>in</sub>,xxx<sub>out</sub></h3>
<div class="outline-text-3" id="text-8-2">
</div><div id="outline-container-sec-8-2-1" class="outline-4">
<h4 id="sec-8-2-1"><span class="section-number-4">8.2.1</span> vim</h4>
<div class="outline-text-4" id="text-8-2-1">
<div class="org-src-container">

<pre class="src src-python">function! s:UserDefPython()
python &lt;&lt; PYTHONEOF
import re
import sys
import vim
def get_proto_key(word,stroe_name):
    if (word.isupper()):
        word=word.lower();

    if  re.search ("_in$", word ): value= word[:-3]
    elif  re.search ("_out$", word ): value=word[:-4]
    elif  re.search ("_cmd$", word ): value=word[:-4]
    else: value=word
    if value!= word:
        key="\&lt;%s_cmd\&gt;\|\&lt;%s\&gt;\|\&lt;%s_in\&gt;\|\&lt;%s_out\&gt;"%(value, value,value,value )
    else: key=word
    vim.command("silent let %s='%s'" % (stroe_name,key))
PYTHONEOF
endfunction

if has('python')
    call s:UserDefPython()
endif

"用于支持 协议查找 ：cmd&lt;-&gt;function&lt;-&gt;in&lt;-&gt;out
function! Proto_find()

    "得到光标下的单词
    let curword=expand("&lt;cword&gt;")
    python get_proto_key(vim.eval("curword"),"find_word" )
    "设置搜索寄存器
    let  @/ = find_word
    call histadd("/", find_word )
    "查找下一个..
    exec "normal! n"
endfunction

map &lt;F7&gt; &lt;Esc&gt;:call Proto_find() &lt;CR&gt;
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-8-2-2" class="outline-4">
<h4 id="sec-8-2-2"><span class="section-number-4">8.2.2</span> emacs</h4>
<div class="outline-text-4" id="text-8-2-2">
<div class="org-src-container">

<pre class="src src-elisp">(defun search-proto-info ()
  "Search for symbol near point.
If FORWARD is nil, search backward, otherwise forward."
  (interactive)
  (let (string obj-str tmp-str )
    (setq isearch-forward t)
    (setq string (evil-find-symbol  t) )

    (if  (null string) 
        (error "No proto item under point"))

    (setq tmp-str "")
    (cond
     ((string= (substring string -4 ) "_out" )
      (setq tmp-str (substring string 0 -4)))
     ((string= (substring string -3 ) "_in" )
      (setq tmp-str (substring string 0 -3)))
     ((string= (substring string -4 ) "_cmd" )
      (setq tmp-str (substring string 0 -4)))
     )
    (if (not (string= tmp-str ""))
    (setq obj-str  (format "\\_&lt;%s_cmd\\_&gt;\\|\\_&lt;%s_in\\_&gt;\\|\\_&lt;%s_out\\_&gt;" tmp-str tmp-str tmp-str   ))
      (setq obj-str string))


    (evil-search obj-str t t)))

;;绑定
(global-set-key (kbd "&lt;f7&gt;") 'search-proto-info )
</pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: jim</p>
<p class="date">Created: 2014-08-05 二 17:38</p>
<p class="creator"><a href="http://www.gnu.org/software/emacs/">Emacs</a> 24.3.1 (<a href="http://orgmode.org">Org</a> mode 8.2.7c)</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
